# Configuração para testes
# Uso: docker-compose -f docker-compose.yml -f docker-compose.test.yml up -d

version: '3.8'

services:
  postgres:
    environment:
      - POSTGRES_DB=cooperados_db_test
      - POSTGRES_USER=cooperados_user_test
      - POSTGRES_PASSWORD=cooperados_pass_test
    ports:
      - "5433:5432"  # Porta diferente para não conflitar
    volumes:
      - postgres_data_test:/var/lib/postgresql/data

  # Serviço de teste que executa os testes
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      - SPRING_PROFILES_ACTIVE=test
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/cooperados_db_test
      - SPRING_DATASOURCE_USERNAME=cooperados_user_test
      - SPRING_DATASOURCE_PASSWORD=cooperados_pass_test
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ~/.m2:/root/.m2
      - ./target:/app/target
    command: ["mvn", "test"]
    profiles:
      - test

volumes:
  postgres_data_test:
    driver: local
